image: registry.gitlab.com/satoshilabs/trezor/trezor-firmware/trezor-firmware-env.nix

# Hardware
hardware core btconly device test:
  stage: test
  tags:
    - tpmb
#  needs:
#    - core fw btconly debug build
  script:
    - cd ci/hardware_tests
    - nix-shell --run "cd ../.. && poetry install"
    - nix-shell --run "mkdir out"
    - nix-shell --run "poetry run strace -f trezorctl list"
    - export TREZOR_PATH=$(./get_trezor_path.sh 'Trezor T')
    - nix-shell --run "echo $TREZOR_PATH"
    - nix-shell --run "poetry run python bootstrap.py tt ../../trezor-*.bin"
    - nix-shell --run "poetry run pytest ../../tests/device_tests"
  timeout: 4h
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    paths:
      - ci/hardware_tests/out/*
    expire_in: 2 days
    when: always
#
#hardware legacy regular device test:
#  stage: test
#  tags:
#    - tpmb
#  needs:
#    - legacy fw regular debug build
#  script:
#    - cd ci/hardware_tests
#    - nix-shell --run "./record_video.sh ${CI_COMMIT_SHORT_SHA} start"
#    - nix-shell --run "cd ../.. && poetry install"
#    - nix-shell --run "poetry run trezorctl list"
#    - export TREZOR_PATH=$(./get_trezor_path.sh 'Trezor 1')
#    - nix-shell --run "echo $TREZOR_PATH"
#    - nix-shell --run "poetry run python bootstrap.py t1"
#    - nix-shell --run "poetry run python bootstrap.py t1 ../../trezor-*.bin"
#    - nix-shell --run "poetry run pytest ../../tests/device_tests"
#    - nix-shell --run "./record_video.sh ${CI_COMMIT_SHORT_SHA} stop"
#  artifacts:
#    name: "$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
#    paths:
#      - ci/hardware_tests/video*.mp4
#    expire_in: 2 days
#    when: always
#
#hardware legacy btconly device test:
#  stage: test
#  variables:
#    TREZOR_PYTEST_SKIP_ALTCOINS: 1
#  tags:
#    - tpmb
#  needs:
#    - legacy fw btconly debug build
#  script:
#    - cd ci/hardware_tests
#    - nix-shell --run "./record_video.sh ${CI_COMMIT_SHORT_SHA} start"
#    - nix-shell --run "cd ../.. && poetry install"
#    - nix-shell --run "poetry run trezorctl list"
#    - export TREZOR_PATH=$(./get_trezor_path.sh 'Trezor 1')
#    - nix-shell --run "echo $TREZOR_PATH"
#    - nix-shell --run "poetry run python bootstrap.py t1"
#    - nix-shell --run "poetry run python bootstrap.py t1 ../../trezor-*.bin"
#    - nix-shell --run "poetry run pytest ../../tests/device_tests"
#    - nix-shell --run "./record_video.sh ${CI_COMMIT_SHORT_SHA} stop"
#  artifacts:
#    name: "$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
#    paths:
#      - ci/hardware_tests/video*.mp4
#    expire_in: 2 days
#    when: always
